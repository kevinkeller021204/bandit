<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      :root {
        --violet:#6d28d9; --slate:#475569; --ink:#0f172a; --muted:#475569;
        --border:#e2e8f0; --border-2:#cbd5e1; --shade:#e5e7eb;
      }
      * { box-sizing:border-box; }
      html, body { height:100%; }
      body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 20px; color:#0f172a; margin:0; }
      h2 { margin: 0 0 14px; }

      /* Topbar */
      .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
      .row { display:flex; gap:12px; align-items:center; }
      button { padding:10px 14px; border-radius:10px; border:0; background:var(--violet); color:#fff; cursor:pointer; }
      button.secondary { background:var(--slate); }
      button.small { padding:8px 10px; border-radius:8px; }
      button:focus-visible { outline:3px solid rgba(124,58,237,.35); outline-offset:2px; }

      #status { margin-top:10px; color:#334155; min-height:1.2em; }
      .hidden { display:none !important; }

      .spinner { width:16px; height:16px; border:3px solid #cbd5e1; border-top-color:var(--violet); border-radius:50%; animation:spin 1s linear infinite; display:none; }
      .spin .spinner { display:inline-block; }
      @keyframes spin { to { transform: rotate(360deg); } }

      a { color:#2563eb; text-decoration:none; }
      a:hover { text-decoration:underline; }

      /* URL-Zeile */
      .url-row { display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-top:8px; padding:10px 12px; border:1px solid var(--shade); border-radius:10px; background:#fff; }
      .url-label { color:#475569; font-size:12px; }
      .url-link { max-width: 70vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

      /* Bühne */
      .stage { position:relative; margin-top:12px; height:70vh; }
      iframe { width:100%; height:100%; border:1px solid var(--shade); border-radius:12px; background:#fff; display:block; }

      /* THEATER-MODUS: nur die Webapp projizieren */
      body.theater { padding:0; }                 /* kein Außenabstand */
      body.theater h2,
      body.theater .topbar,
      body.theater #urlRow,
      body.theater #status { display:none !important; }
      body.theater .stage { height:100vh; margin:0; }
      body.theater iframe { border:0; border-radius:0; }

      /* Exit-Pill */
      .fs-exit {
        position:absolute; right:18px; bottom:18px; z-index:10;
        background:rgba(15,23,42,.72); color:#fff; border-radius:999px; padding:8px 12px;
        font-size:12px; display:none; align-items:center; gap:6px;
        box-shadow:0 8px 24px rgba(2,6,23,.25);
        backdrop-filter:saturate(120%) blur(2px);
        border:1px solid rgba(255,255,255,.12);
      }
      .fs-exit svg { width:14px; height:14px; }
      body.theater .fs-exit { display:flex; }

      /* Modal (ngrok) */
      .modal.hidden { display:none; }
      .modal { position:fixed; inset:0; z-index:1000; display:grid; place-items:center; }
      .modal__backdrop { position:absolute; inset:0; background:rgba(15, 23, 42, .45); backdrop-filter:saturate(120%) blur(2px); }
      .modal__dialog {
        position:relative; z-index:1; width:min(92vw, 420px);
        background:#fff; color:var(--ink); border-radius:14px; padding:16px 14px;
        box-shadow:0 20px 50px rgba(2,6,23,.25), 0 6px 18px rgba(2,6,23,.18);
        border:1px solid var(--border);
      }
      .modal__header { margin-bottom:6px; }
      .modal__header h3 { margin:0; font-size:16px; font-weight:700; letter-spacing:.2px; }
      .modal__hint { margin:6px 0 12px; font-size:12px; color:#475569; }
      .modal__input {
        width:calc(100% - 4px); padding:8px 10px; border:1px solid var(--border-2); border-radius:8px;
        font-family:ui-monospace, SFMono-Regular, Menlo, monospace; box-sizing:border-box;
      }
      .modal__input:focus { outline:none; border-color:#7c3aed; box-shadow:0 0 0 3px rgba(124,58,237,.15); }
      .modal__actions { display:flex; align-items:center; gap:8px; margin-top:14px; }
      .modal .spacer { flex:1; }
    </style>
  </head>
  <body>
    <h2>Bandit App</h2>

    <!-- Top-Leiste -->
    <div class="topbar">
      <div class="row">
        <button id="offline">Host offline</button>
        <button id="online" class="secondary">Host online</button>
        <button id="del-ngrok" class="secondary" style="display:none;">ngrok-Token löschen</button>
        <div class="spinner" id="spin"></div>
      </div>
      <div class="row">
        <button id="fullscreenBtn" class="secondary" title="Web-App projizieren">Vollbild</button>
      </div>
    </div>

    <!-- ngrok Modal -->
    <div id="ngrok-modal" class="modal hidden" aria-hidden="true" role="dialog" aria-labelledby="ngrok-title">
      <div class="modal__backdrop"></div>
      <div class="modal__dialog" role="document">
        <div class="modal__header"><h3 id="ngrok-title">ngrok Authtoken</h3></div>
        <p class="modal__hint">Melde dich bei ngrok an. Deinen persönlichen Authtoken findest du im Dashboard unter „Your Authtoken“.</p>
        <input id="ngrok-input" type="text" class="modal__input" placeholder="xxxxxxxxxxxxxxxxxxxxxx" />
        <div class="modal__actions">
          <button id="ngrok-open" class="secondary" type="button">ngrok öffnen</button>
          <div class="spacer"></div>
          <button id="ngrok-cancel" type="button">Abbrechen</button>
          <button id="ngrok-save" type="button">Speichern</button>
        </div>
      </div>
    </div>

    <!-- Status (blendet sich weg, sobald URL gesetzt ist) -->
    <div id="status"></div>

    <!-- URL + Kopieren -->
    <div id="urlRow" class="url-row hidden">
      <span class="url-label">Läuft unter:</span>
      <a id="currentUrl" class="url-link" href="#" target="_blank" rel="noreferrer"></a>
      <button id="copyUrl" class="small secondary" type="button">Kopieren</button>
    </div>

    <!-- Bühne -->
    <div class="stage" id="stage">
      <iframe id="appframe" src="about:blank" title="Bandit App"></iframe>

      <!-- dezenter Exit-Pill -->
      <button id="fsExit" class="fs-exit" type="button" title="Vollbild beenden">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 3H5a2 2 0 0 0-2 2v4M15 3h4a2 2 0 0 1 2 2v4M9 21H5a2 2 0 0 1-2-2v-4M15 21h4a2 2 0 0 0 2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Vollbild beenden
      </button>
    </div>

    <script>
      // Elements
      const spin         = document.getElementById('spin');
      const statusEl     = document.getElementById('status');
      const frame        = document.getElementById('appframe');
      const btnDelNgrok  = document.getElementById('del-ngrok');
      const fullscreenBtn= document.getElementById('fullscreenBtn');
      const fsExit       = document.getElementById('fsExit');

      const urlRow       = document.getElementById('urlRow');
      const currentUrlEl = document.getElementById('currentUrl');
      const copyUrlBtn   = document.getElementById('copyUrl');
      let lastUrl = '';
      let didAutoTheater = false;
      // Modal
      const modal       = document.getElementById('ngrok-modal');
      const ngrokInput  = document.getElementById('ngrok-input');
      const ngrokOpen   = document.getElementById('ngrok-open');
      const ngrokSave   = document.getElementById('ngrok-save');
      const ngrokCancel = document.getElementById('ngrok-cancel');

      // Helpers
      function setSpin(on){ document.body.classList.toggle('spin', !!on); }
      function showModal(){ modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); setTimeout(()=> ngrokInput.focus(), 0); }
      function hideModal(){ modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }
      function clearStatus(){ statusEl.textContent=''; statusEl.classList.add('hidden'); }
      function showStatus(msg){ statusEl.textContent = msg; statusEl.classList.remove('hidden'); }

      // Startup
      window.bandit.send('check-credentials');

      // Credentials UI
      window.bandit.on('credentials-status', (s) => { btnDelNgrok.style.display = s.ngrok ? '' : 'none'; });
      window.bandit.on('credentials-changed', (d) => { if (typeof d.ngrok === 'boolean') btnDelNgrok.style.display = d.ngrok ? '' : 'none'; });
      btnDelNgrok.onclick = () => { if (confirm('ngrok-Token wirklich löschen?')) window.bandit.send('delete-credentials', 'ngrok'); };

      // ngrok modal
      window.bandit.on('need-ngrok-token', () => { ngrokInput.value = ''; showModal(); });
      ngrokOpen.onclick   = () => window.bandit.send('open-external', 'https://dashboard.ngrok.com/get-started/your-authtoken');
      ngrokSave.onclick   = () => {
        const val = ngrokInput.value.trim();
        if (!val) { alert('Bitte Token eintragen'); return; }
        hideModal(); window.bandit.send('set-ngrok-token', val);
        showStatus('Token gespeichert. Starte ngrok …');
      };
      ngrokCancel.onclick = () => { hideModal(); showStatus('ngrok abgebrochen.'); };
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.classList.contains('hidden')) hideModal(); });

      // Host controls
      document.getElementById('offline').onclick = () => {
        setSpin(true); clearUrlRow(); frame.src = "about:blank";
        window.bandit.send('host-offline');
      };
      document.getElementById('online').onclick = () => {
        setSpin(true); clearUrlRow(); frame.src = "about:blank";
        window.bandit.send('host-online');
      };

      // IPC listeners
      window.bandit.on('status', (msg)=> {
        if (!lastUrl) showStatus(msg);
        if (msg.toLowerCase().includes("bereit")) setSpin(false);
      });

      window.bandit.on('open-url', (url)=> { // lokale App-URL
        setUrlRow(url);
        frame.src = url;
        setSpin(false);
        clearStatus();
      });

      window.bandit.on('public-url', (url)=> { // öffentliche URL
        setUrlRow(url);
        clearStatus();
      });

      window.bandit.on('error', (msg)=> { setSpin(false); showStatus("Fehler: " + msg); });

      // URL helpers
      function setUrlRow(url){
        lastUrl = url || '';
        if (!lastUrl) { clearUrlRow(); return; }
        currentUrlEl.textContent = lastUrl;
        currentUrlEl.href = lastUrl;
        urlRow.classList.remove('hidden');
      }
      function clearUrlRow(){
        lastUrl = '';
        urlRow.classList.add('hidden');
        currentUrlEl.textContent = '';
        currentUrlEl.removeAttribute('href');
      }
      copyUrlBtn.onclick = async () => {
        if (!lastUrl) return;
        try {
          await navigator.clipboard.writeText(lastUrl);
          const old = copyUrlBtn.textContent;
          copyUrlBtn.textContent = 'Kopiert!';
          setTimeout(()=> copyUrlBtn.textContent = old, 900);
        } catch {
          alert('Kopieren fehlgeschlagen');
        }
      };

      // THEATER-MODUS (nur Web-App projizieren)
      let theater = false;
      const toggleTheater = (on) => {
        theater = (typeof on === 'boolean') ? on : !theater;
        document.body.classList.toggle('theater', theater);
        fullscreenBtn.textContent = theater ? 'Vollbild beenden' : 'Vollbild';
      };
      fullscreenBtn.onclick = () => toggleTheater();
      fsExit.onclick        = () => toggleTheater(false);
      
      frame.addEventListener('load', () => {
      if (!didAutoTheater) {
        didAutoTheater = true;
        // kleines Delay, damit Layout/CSS sicher fertig ist
        setTimeout(() => toggleTheater(true), 120);
      }
    });

    </script>
  </body>
</html>
