<!doctype html>
<html>
  <head>
    <meta charset="utf-8"><title>Bandit App</title>
    <style>
      body { font-family: ui-sans-serif, system-ui; padding: 20px; }
      .row { display:flex; gap:12px; align-items:center; }
      button { padding:10px 14px; border-radius:10px; border:0; background:#6d28d9; color:#fff; cursor:pointer; }
      button.secondary { background:#475569; }
      #status { margin-top:14px; color:#334155; }
      .spinner { width:16px; height:16px; border:3px solid #cbd5e1; border-top-color:#6d28d9; border-radius:50%; animation:spin 1s linear infinite; display:none; }
      .spin .spinner { display:inline-block; }
      a { color:#2563eb; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .url { margin-top:10px; }
      iframe { width:100%; height:70vh; border:1px solid #e5e7eb; border-radius:12px; margin-top:16px; }
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <h2>Bandit App</h2>
    <div class="row">
      <button id="offline">Host offline</button>
      <button id="online" class="secondary">Host online (ngrok)</button>
      <button id="del-ngrok"  class="secondary" style="display:none;">ngrok-Token löschen</button>
      <button id="del-github" class="secondary" style="display:none;">GitHub-Token löschen</button>
      <div class="spinner" id="spin"></div>
      <div id="device" style="margin-top:10px; padding:10px; background:#f1f5f9; border-radius:8px; display:none;">
        <div><strong>GitHub Code:</strong> <span id="device-code" style="font-family:monospace;"></span></div>
        <div style="margin-top:6px;">
            1) <a href="https://github.com/login/device" target="_blank">github.com/login/device</a> öffnen<br>
            2) Code oben eingeben und bestätigen
        </div>
        </div>

    </div>
        <div id="ngrok-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div style="max-width:420px;margin:10% auto;background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);">
        <div style="font-weight:600;margin-bottom:8px;">ngrok Authtoken</div>
        <div style="font-size:12px;color:#555;margin-bottom:8px;">Füge deinen ngrok Authtoken ein. Er wird sicher gespeichert.</div>
        <input id="ngrok-input" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px;" placeholder="xxxxxxxxxxxxxxxxxxxxxx">
        <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="ngrok-cancel" class="btn">Abbrechen</button>
        <button id="ngrok-save" class="btn">Speichern</button>
        </div>
    </div>
    </div>
    <div id="status"></div>
    <div id="public-url" class="url"></div>
    <iframe id="appframe" src="about:blank"></iframe>

<script>
  const spin      = document.getElementById('spin');
  const status    = document.getElementById('status');
  const urlBox    = document.getElementById('public-url');
  const frame     = document.getElementById('appframe');
  const deviceBox = document.getElementById('device');
  const deviceSpan= document.getElementById('device-code');
// Elemente
  const modal = document.getElementById('ngrok-modal');
  const ngrokInput = document.getElementById('ngrok-input');
  const ngrokSave = document.getElementById('ngrok-save');
  const ngrokCancel = document.getElementById('ngrok-cancel');
  const btnDelNgrok  = document.getElementById('del-ngrok');
  const btnDelGithub = document.getElementById('del-github');

  // beim Start den Status anfordern
  window.bandit.send('check-credentials');

  // Antwort: Buttons ein-/ausblenden
  window.bandit.on('credentials-status', (s) => {
    btnDelNgrok.style.display  = s.ngrok  ? '' : 'none';
    btnDelGithub.style.display = s.github ? '' : 'none';
  });

  // live updaten, wenn sich etwas ändert (z.B. nach Speichern/Löschen)
  window.bandit.on('credentials-changed', (delta) => {
    if (typeof delta.ngrok  === 'boolean')  btnDelNgrok.style.display  = delta.ngrok  ? '' : 'none';
    if (typeof delta.github === 'boolean')  btnDelGithub.style.display = delta.github ? '' : 'none';
  });

  // Klick-Handler
  btnDelNgrok.onclick = () => {
    if (confirm('ngrok-Token wirklich löschen?'))  window.bandit.send('delete-credentials', 'ngrok');
  };
  btnDelGithub.onclick = () => {
    if (confirm('GitHub-Token wirklich löschen?')) window.bandit.send('delete-credentials', 'github');
  };
// Main sagt: Token wird benötigt
window.bandit.on('need-ngrok-token', () => {
  ngrokInput.value = '';
  modal.style.display = 'block';
  ngrokInput.focus();
});

// Speichern -> an Main schicken
ngrokSave.onclick = () => {
  const val = ngrokInput.value.trim();
  if (!val) { alert('Bitte Token eintragen'); return; }
  modal.style.display = 'none';
  window.bandit.send('set-ngrok-token', val);
  // UI-Feedback
  status.textContent = 'Token gespeichert. Starte ngrok …';
};

// Abbrechen
ngrokCancel.onclick = () => {
  modal.style.display = 'none';
  status.textContent = 'ngrok abgebrochen.';
};

// Öffentliche URL anzeigen (z. B. unter deiner URL-Box)
window.bandit.on('public-url', (url) => {
  urlBox.innerHTML = `<a href="${url}" target="_blank" rel="noreferrer">${url}</a>`;
});

  function setSpin(on){ document.body.classList.toggle('spin', !!on); }

  // Button-Events
    document.getElementById('offline').onclick = () => {
    setSpin(true); urlBox.innerHTML = ""; frame.src = "about:blank";
    if (!window.bandit) {
        status.textContent = "IPC-Bridge fehlt (Preload)";
        return;
    }
    window.bandit.send('host-offline');
    };


  document.getElementById('online').onclick = () => {
    setSpin(true); urlBox.innerHTML = ""; frame.src = "about:blank";
    window.bandit.send('host-online');
  };

  // IPC-Empfänger
  window.bandit.on('device-code', (code)=>{
    deviceSpan.textContent = code;
    deviceBox.style.display = 'block';
  });

  window.bandit.on('status', (msg)=> {
    status.textContent = msg;
    if (msg.toLowerCase().includes("bereit")) setSpin(false);
  });

  window.bandit.on('open-url', (url)=> {
    frame.src = url;
    setSpin(false);
  });

  window.bandit.on('public-url', (url)=> {
    urlBox.innerHTML = `Öffentlich: <a href="${url}" target="_blank">${url}</a>`;
  });

  window.bandit.on('error', (msg)=> {
    setSpin(false);
    status.textContent = "Fehler: " + msg;
  });
</script>

  </body>
</html>
