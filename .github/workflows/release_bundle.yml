name: Build release bundle (backend+frontend)

on:
  push:
    tags: ["v*"]

jobs:
  build-bundle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Frontend build
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      # Backend -> Single binary
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Build backend binary
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          pyinstaller --onefile --name bandit-server app.py
          # Binary: backend/dist/bandit-server

      - name: Make bundle
        run: |
          mkdir -p bundle/frontend_dist
          cp backend/dist/bandit-server bundle/
          cp -R frontend/dist/* bundle/frontend_dist/
          cd bundle && zip -r ../bandit-local.zip . && cd ..
          sha256sum bandit-local.zip > SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bandit-local.zip
            SHA256SUMS
